{
  "metadata": {
    "reviewDate": "2026-02-09",
    "reviewer": "Bill (Claude Code)",
    "purpose": "Comprehensive passive code review for optimization, security, consistency, and maintainability",
    "scope": "Entire Prix Six codebase",
    "totalIssuesFound": 505,
    "reviewStatus": "in_progress",
    "progressPercent": 100,
    "reviewStartTime": "2026-02-09T21:01:00Z",
    "lastUpdated": "2026-02-13T00:10:00Z",
    "completedTime": "2026-02-10T02:30:00Z",
    "modulesCompleted": 17,
    "modulesTotal": 17,
    "totalFilesReviewed": 293,
    "totalLinesReviewed": "~55000",
    "remediationPlanCreated": true,
    "issuesRemediated": 12,
    "remediationPercent": 2.4,
    "lastMergeFrom": "RedTeam.json",
    "lastMergeDate": "2026-02-12T23:02:57Z",
    "lastMergeBy": "Ben (Claude Code)",
    "issuesAddedFromRedTeam": 9,
    "geminiAudit": {
      "guid": "gemini-audit-progress-tracker-2026-02-12",
      "task": "Your role is the security auditor. First task 01 - I want you to read the book-of-work.json and be mindful of its content its the work which claude code is working on right now it changes - then task 2 with it in mind - I want you to read the file \"code.json\" and then open the source code that the modules point too,  you are to scrutinise and scour the whole code base looking for security issues (think like a hacker OSWAP ++)  when you find a flaw which does not already exist within the RedTeam.json or does not already exist in the book of work.json then add it to BOTH  as new entries following the existing patterns. Use aggressive checkpointing as required. Write in the RedTeam.json a new section when you start to describe what it is you have been asked to do and how much progress you have made. Be verbose in your standard output so you show me here what module/file you're working on, and how many new flaws/bugs/exploits you have found in this session. Expect to crash and have to pick it up from last check point so write yourself some good notes. When you restart I will point you (red team) at red-team.json - now go for it Red Team go get them..",
      "status": "in_progress",
      "progress_percent": 4.8,
      "files_audited": 6,
      "new_flaws_found_session": 5,
      "last_file_audited": "app/src/app/(app)/admin/_components/HotNewsManager.tsx",
      "last_checkpoint": "2026-02-12T12:30:00Z",
      "notes": "Synchronized ADMINCOMP-006 from book-of-work.json. Continuing to next file."
    }
  },
  "remediation": {
    "ADMINCOMP-012": {
      "status": "completed",
      "version": "1.34.0",
      "date": "2026-02-10",
      "commitHash": "c9a198d",
      "description": "Replaced direct Firestore writes with API endpoint for error dismissal",
      "severity": "critical"
    },
    "ADMINCOMP-013": {
      "status": "completed",
      "version": "1.34.0",
      "date": "2026-02-10",
      "commitHash": "71eec1c",
      "description": "Replaced direct Firestore writes with API endpoint for attack acknowledgement",
      "severity": "critical"
    },
    "GEMINI-005": {
      "status": "completed",
      "version": "1.34.0",
      "date": "2026-02-10",
      "commitHash": "17b9b5d",
      "description": "Implemented CSRF protection on authentication endpoints",
      "severity": "critical"
    },
    "ADMINCOMP-023": {
      "status": "completed",
      "version": "1.34.0",
      "date": "2026-02-10",
      "commitHash": "48305cf",
      "description": "Implemented cascade deletion for race predictions",
      "severity": "high"
    },
    "GEMINI-007": {
      "status": "completed",
      "version": "1.34.0",
      "date": "2026-02-10",
      "commitHash": "431c819",
      "description": "Restricted Firebase Storage profile photos to authenticated users",
      "severity": "critical"
    },
    "ADMINCOMP-003": {
      "status": "completed",
      "version": "1.55.4",
      "date": "2026-02-12",
      "commitHash": "1c79380",
      "description": "Created admin verification endpoints with magic link MFA",
      "severity": "critical"
    },
    "EMAIL-003": {
      "status": "completed",
      "version": "1.55.5",
      "date": "2026-02-12",
      "commitHash": "5aa15ae",
      "description": "Fixed sendEmail parameter names in admin-challenge endpoint",
      "severity": "medium"
    },
    "ERROR-HANDLING-GAPS": {
      "status": "completed",
      "version": "1.55.6",
      "date": "2026-02-12",
      "commitHash": "ca3fcab",
      "description": "Added error code and correlation ID to all email verification errors",
      "severity": "high",
      "note": "Golden Rule #1 compliance"
    },
    "ADMIN-VERIFY-UX-001": {
      "status": "completed",
      "version": "1.55.7",
      "date": "2026-02-12",
      "commitHash": "4b4cac2",
      "description": "Fixed splash screen skip and parameter mismatch in admin verification",
      "severity": "medium"
    },
    "EMAIL-TRACEABILITY": {
      "status": "completed",
      "version": "1.55.8",
      "date": "2026-02-12",
      "commitHash": "9395720",
      "description": "Added build version to all email footers for support traceability",
      "severity": "low"
    },
    "ADMINCOMP-003-COOKIE": {
      "status": "completed",
      "version": "1.55.9",
      "date": "2026-02-12",
      "commitHash": "e5b0230",
      "description": "Set adminVerified cookie in verify-access API, removed duplicate email footer",
      "severity": "critical",
      "note": "Fixed redirect loop to validation page"
    },
    "BACKUP-STORAGE-GAP": {
      "status": "completed",
      "version": "1.55.4",
      "date": "2026-02-12",
      "commitHash": "75f7b13",
      "description": "Added Firebase Storage backup to daily backup job with smoke test verification",
      "severity": "high"
    }
  },
  "summary": {
    "byCategory": {
      "security": 160,
      "performance": 41,
      "errorHandling": 49,
      "consistency": 47,
      "maintainability": 83,
      "goldenRuleViolation": 33,
      "accessibility": 8,
      "reliability": 4,
      "documentation": 80
    },
    "bySeverity": {
      "critical": 50,
      "high": 90,
      "medium": 183,
      "low": 179
    }
  },
  "agentReports": {
    "apiRoutes": {
      "agentId": "a1dfa82",
      "status": "completed",
      "issuesFound": 47,
      "severity": {
        "critical": 3,
        "high": 9,
        "medium": 22,
        "low": 13
      }
    },
    "errorHandling": {
      "agentId": "a030a0d",
      "status": "completed",
      "complianceScore": "82/100",
      "criticalViolations": [
        "Cloud Functions hardcode error codes",
        "Legacy lib/ modules bypass traced-error system"
      ]
    },
    "adminPanel": {
      "agentId": "a833757",
      "status": "completed",
      "issuesFound": 12,
      "severity": {
        "critical": 2,
        "high": 3,
        "medium": 5,
        "low": 2
      }
    },
    "scoringEngine": {
      "agentId": "a11e0a3",
      "status": "completed",
      "grade": "A (Excellent)",
      "criticalIssues": 0,
      "recommendations": 2
    },
    "whatsappIntegration": {
      "agentId": "aaceff7",
      "status": "completed",
      "issuesFound": 31,
      "severity": {
        "critical": 4,
        "high": 9,
        "medium": 11,
        "low": 7
      }
    },
    "emailSystem": {
      "agentId": "acc6231",
      "status": "completed",
      "issuesFound": 31,
      "severity": {
        "critical": 5,
        "high": 8,
        "medium": 12,
        "low": 6
      }
    },
    "backupRecovery": {
      "agentId": "ae1da64",
      "status": "completed",
      "issuesFound": 15,
      "severity": {
        "critical": 1,
        "high": 3,
        "medium": 7,
        "low": 4
      }
    },
    "cloudFunctions": {
      "agentId": "a813e4d",
      "status": "completed",
      "issuesFound": 25,
      "grade": "B+ (would be A with Golden Rule violations fixed)",
      "severity": {
        "critical": 4,
        "high": 7,
        "medium": 8,
        "low": 6
      }
    },
    "firestoreRules": {
      "agentId": "aa27d89",
      "status": "completed",
      "securityGrade": "C-",
      "issuesFound": 12,
      "severity": {
        "critical": 3,
        "high": 4,
        "medium": 3,
        "low": 2
      }
    },
    "frontendComponents": {
      "agentId": "af9da38",
      "status": "completed",
      "issuesFound": 27,
      "grade": "Production-ready with noted improvements",
      "severity": {
        "critical": 1,
        "high": 6,
        "medium": 12,
        "low": 8
      }
    },
    "supportingLibraries": {
      "agentId": "a74345f",
      "status": "completed",
      "issuesFound": 30,
      "grade": "Well-structured with critical security fixes needed",
      "severity": {
        "critical": 3,
        "high": 7,
        "medium": 12,
        "low": 8
      }
    },
    "configurationFiles": {
      "agentId": "a6cc933",
      "status": "completed",
      "issuesFound": 23,
      "overallRisk": "HIGH",
      "severity": {
        "critical": 1,
        "high": 10,
        "medium": 9,
        "low": 3
      }
    },
    "deploymentConfiguration": {
      "agentId": "a1f8c00",
      "status": "completed",
      "issuesFound": 18,
      "severity": {
        "critical": 5,
        "high": 6,
        "medium": 5,
        "low": 2
      }
    },
    "adminComponentsAudit": {
      "agentId": "afe90b1",
      "status": "completed",
      "issuesFound": 45,
      "severity": {
        "critical": 11,
        "high": 14,
        "medium": 20,
        "low": 0
      }
    },
    "codeDocumentationGaps": {
      "agentId": "a9e4d82",
      "status": "completed",
      "issuesFound": 111,
      "severity": {
        "critical": 0,
        "high": 0,
        "medium": 20,
        "low": 91
      }
    }
  },
  "criticalIssues": [
    {
      "id": "remediationPlan",
      "module": "Remediation Plan",
      "severity": "critical",
      "issue": "Remediation Plan for Critical Vulnerabilities",
      "impact": "This plan outlines the steps to remediate critical vulnerabilities found in the system.",
      "file": "RedTeam.json"
    },
    {
        "id": "GEMINI-AUDIT-013",
        "module": "Supporting Libraries",
        "severity": "low",
        "issue": "Inconsistent Correlation ID Generation",
        "impact": "The `generateGuid` function uses `Math.random()` to generate a GUID, which is not cryptographically secure. The `logPermissionError` function uses `crypto.randomUUID()`, which is a cryptographically secure method. This is an inconsistency that could be improved by using `crypto.randomUUID()` everywhere for generating correlation IDs.",
        "file": "app/src/lib/audit.ts"
    },
    {
        "id": "GEMINI-AUDIT-012",
        "module": "Security / Attack Detection",
        "severity": "critical",
        "issue": "Missing Account Lockout Mechanism",
        "impact": "The attack detection system identifies various types of attacks, but it does not implement any account lockout mechanism. This means that even if an attack is detected, the attacker can continue to try to log in. A proper implementation should temporarily or permanently lock the account after a certain number of failed login attempts. The code itself acknowledges this with the comment `@AUDIT_NOTE: Account lockout (auto-locking accounts after repeated failures) not implemented`.",
        "file": "app/src/lib/attack-detection.ts"
    },
    {
        "id": "GEMINI-AUDIT-011",
        "module": "Frontend Components",
        "severity": "high",
        "issue": "Missing CSRF Protection in Login Function",
        "impact": "The `login` function in the `FirebaseProvider` makes a `POST` request to `/api/auth/login` without including a CSRF token. While modern browsers have SameSite cookie policies, this is not a complete defense. An attacker could still trick a user's browser into submitting malicious requests to this endpoint under certain conditions, potentially leading to unauthorized actions. A double-submit cookie or a token-based approach should be implemented to mitigate this risk.",
        "file": "app/src/firebase/provider.tsx"
    },
    {
        "id": "GEMINI-AUDIT-010",
        "module": "Frontend Components",
        "severity": "critical",
        "issue": "Unauthenticated AI Analysis Request from Prediction Editor",
        "impact": "The `handleAnalysis` function in the `PredictionEditor` component makes a `POST` request to `/api/ai/analysis` without including an `Authorization` header. This means the request is unauthenticated, allowing any user to trigger the expensive AI analysis, leading to a Denial of Wallet (DoW) vulnerability. The `idToken` from the authenticated user should be included in the request header.",
        "file": "app/src/app/(app)/predictions/_components/PredictionEditor.tsx"
    },
    {
        "id": "GEMINI-AUDIT-009",
        "module": "Cloud Functions",
        "severity": "critical",
        "issue": "Hardcoded Error Codes in Cloud Functions",
        "impact": "Multiple Cloud Functions hardcode error codes (e.g., PX-7002, PX-7008) instead of importing them from the central `ERRORS` registry. This violates 'Golden Rule #7', creates a maintenance risk, and means error definitions can drift from the centralized source of truth, hindering debugging and consistent error handling.",
        "file": "functions/index.js"
    },
    {
        "id": "GEMINI-AUDIT-008",
        "module": "API Routes",
        "severity": "medium",
        "issue": "Secondary Email Verification Endpoint Relies Solely on Token Authentication.",
        "impact": "The `/api/verify-secondary-email` endpoint uses a token-based authentication mechanism, which is a common and valid pattern. However, it does not require the user to be logged in. An attacker who gains access to a user's email account could verify the secondary email address without the user's knowledge. Requiring a logged-in session to complete the verification would add an extra layer of security.",
        "file": "app/src/app/api/verify-secondary-email/route.ts"
    },
    {
        "id": "GEMINI-AUDIT-007",
        "module": "API Routes",
        "severity": "medium",
        "issue": "Email Verification Endpoint Relies Solely on Token Authentication.",
        "impact": "The `/api/verify-email` endpoint uses a token-based authentication mechanism, which is a common and valid pattern. However, it does not require the user to be logged in. An attacker who gains access to a user's email account could verify the email address without the user's knowledge. Requiring a logged-in session to complete the verification would add an extra layer of security.",
        "file": "app/src/app/api/verify-email/route.ts"
    },
    {
      "id": "GEMINI-AUDIT-006",
      "module": "API Routes",
      "severity": "critical",
      "issue": "Unauthenticated Secondary Email Manipulation and Potential Account Takeover Vector",
      "impact": "The `/api/update-secondary-email` endpoint is unauthenticated. It accepts a `uid` from the request body and proceeds to change the secondary email for that user account. An attacker who can guess or obtain a user's UID can call this endpoint to set the secondary email to an address they control. If secondary email is used for any password reset or notification mechanisms, this could serve as a vector for account takeover. The endpoint MUST be protected and verify that the authenticated user's UID matches the UID in the request body.",
      "file": "app/src/app/api/update-secondary-email/route.ts"
    },
    {
      "id": "GEMINI-AUDIT-005",
      "module": "Admin Components",
      "severity": "high",
      "issue": "Insecure Direct Object Modification of Feedback Items",
      "impact": "The FeedbackManager component performs all status updates and deletions by writing directly to the Firestore `feedback` collection from the client. An attacker who bypasses client-side navigation controls could arbitrarily modify or delete any user-submitted feedback.",
      "file": "app/src/app/(app)/admin/_components/FeedbackManager.tsx"
    },
    {
      "id": "GEMINI-AUDIT-004",
      "module": "Admin Components",
      "severity": "medium",
      "issue": "Denial of Wallet via Unbounded Admin-Triggered Read Operations",
      "impact": "The Consistency Checker component's `runChecks` function fetches multiple entire Firestore collections. A malicious or careless administrator could repeatedly trigger this check, causing a massive number of document reads and incurring potentially unbounded costs.",
      "file": "app/src/app/(app)/admin/_components/ConsistencyChecker.tsx"
    },
    {
      "id": "GEMINI-AUDIT-003",
      "module": "Admin Components",
      "severity": "critical",
      "issue": "Stored XSS via Unescaped Team Name in Audit Log Viewer",
      "impact": "An attacker can set their team name to a malicious JavaScript payload. When an administrator views the audit log, the script will execute in their browser, leading to session hijacking.",
      "file": "app/src/app/(app)/admin/_components/AuditLogViewer.tsx"
    },
    {
      "id": "GEMINI-AUDIT-002",
      "module": "Admin Components",
      "severity": "critical",
      "issue": "Authorization Bypass by Disabling Global Audit Logging",
      "impact": "An attacker who bypasses client-side navigation controls could call the underlying `updateAuditSettings` function from their browser console to disable all audit logging system-wide, effectively blinding the application to further malicious activity.",
      "file": "app/src/app/(app)/admin/_components/AuditManager.tsx"
    },
    {
      "id": "GEMINI-AUDIT-001",
      "module": "Admin Components",
      "severity": "high",
      "issue": "Stored XSS Vulnerability in Attack Monitor Details",
      "impact": "If an attacker can inject malicious HTML into the attack_alerts collection, they could execute scripts in an admin's browser, leading to session hijacking.",
      "file": "app/src/app/(app)/admin/_components/AttackMonitor.tsx"
    },
    {
      "id": "AUTH-003",
      "module": "Authentication",
      "severity": "critical",
      "issue": "Auth state race condition between onAuthStateChanged and Firestore snapshot",
      "impact": "Components checking firebaseUser but not isUserLoading could expose authenticated routes before user profile loads",
      "file": "app/src/firebase/provider.tsx:186"
    },
    {
      "id": "API-006",
      "module": "API Routes",
      "severity": "critical",
      "issue": "PIN reset timing attack enables email enumeration",
      "impact": "Timing difference between 'user not found' (fast) and 'user found' (slow) allows attackers to determine valid emails",
      "file": "app/api/auth/reset-pin/route.ts:63"
    },
    {
      "id": "API-013",
      "module": "API Routes",
      "severity": "critical",
      "issue": "Insufficient authorization for predictions - no team ownership check",
      "impact": "Attacker could submit predictions for another user's secondary team",
      "file": "app/api/submit-prediction/route.ts:53"
    },
    {
      "id": "ADMIN-005",
      "module": "Admin Panel",
      "severity": "critical",
      "issue": "Private league invite codes displayed in plaintext without access control",
      "impact": "Compromised admin account could join all private leagues",
      "file": "app/(app)/admin/_components/LeaguesManager.tsx:140-154"
    },
    {
      "id": "ERROR-CLOUD-001",
      "module": "Error Handling",
      "severity": "critical",
      "issue": "Cloud Functions hardcode error codes, bypassing error registry",
      "impact": "Violates Golden Rule #7, creates maintenance risk, error definitions can drift from registry",
      "file": "functions/index.js:267,422,620,962"
    },
    {
      "id": "WHATSAPP-001",
      "module": "WhatsApp Integration",
      "severity": "critical",
      "issue": "API key authentication is optional and uses weak header checking",
      "impact": "If WORKER_API_KEY is not set, anyone can trigger queue processing",
      "file": "whatsapp-worker/src/index.ts:148-155"
    },
    {
      "id": "WHATSAPP-002",
      "module": "WhatsApp Integration",
      "severity": "critical",
      "issue": "No authentication on health, status, QR, and ping endpoints",
      "impact": "/qr endpoint exposes authentication QR codes to anyone. Potential session hijacking",
      "file": "whatsapp-worker/src/index.ts:17-120"
    },
    {
      "id": "WHATSAPP-003",
      "module": "WhatsApp Integration",
      "severity": "critical",
      "issue": "Missing validation of Azure Storage connection string",
      "impact": "Application crashes on startup with credentials exposed in error logs",
      "file": "whatsapp-worker/src/azure-store.ts:19-24"
    },
    {
      "id": "WHATSAPP-004",
      "module": "WhatsApp Integration",
      "severity": "critical",
      "issue": "Service account credentials loaded from environment variable without validation",
      "impact": "Invalid JSON causes startup crash with potentially exposed partial credentials",
      "file": "whatsapp-worker/src/firebase-config.ts:14-16,32-33"
    },
    {
      "id": "EMAIL-001",
      "module": "Email System",
      "severity": "critical",
      "issue": "HTML injection vulnerability in email templates",
      "impact": "User-controlled data directly interpolated into HTML without sanitization. XSS attacks possible",
      "file": "app/src/lib/email.ts:116-173,292-299"
    },
    {
      "id": "EMAIL-002",
      "module": "Email System",
      "severity": "critical",
      "issue": "Unvalidated URL construction for verification links",
      "impact": "URL injection if UID contains special characters",
      "file": "app/api/send-verification-email/route.ts:79-80"
    },
    {
      "id": "EMAIL-003",
      "module": "Email System",
      "severity": "critical",
      "issue": "Credential exposure in error messages",
      "impact": "Azure AD errors could contain partial credential info in logs",
      "file": "app/src/lib/email.ts:67-69"
    },
    {
      "id": "EMAIL-004",
      "module": "Email System",
      "severity": "critical",
      "issue": "Unescaped user-generated content in hot news HTML email",
      "impact": "Admin-generated content could include malicious HTML. Broadcast to all users",
      "file": "app/api/send-hot-news-email/route.ts:254-284"
    },
    {
      "id": "EMAIL-005",
      "module": "Email System",
      "severity": "critical",
      "issue": "Multiple XSS vectors in results email template",
      "impact": "XSS via crafted team/race/driver names in results emails sent to all users",
      "file": "app/api/send-results-email/route.ts:222-320"
    },
    {
      "id": "BACKUP-001",
      "module": "Backup & Recovery",
      "severity": "critical",
      "issue": "Service account private key exposed in repository",
      "impact": "Anyone with repo access can bypass all Firestore security, export/modify/delete data",
      "file": "scripts/service-account.json:1-13"
    },
    {
      "id": "CLOUD-001",
      "module": "Cloud Functions",
      "severity": "critical",
      "issue": "Golden Rule #7 Violation - Hardcoded error code PX-7002 at line 267",
      "impact": "Error bypasses centralized registry. Cannot benefit from TracedError metadata",
      "file": "functions/index.js:267"
    },
    {
      "id": "CLOUD-002",
      "module": "Cloud Functions",
      "severity": "critical",
      "issue": "Golden Rule #7 Violation - Hardcoded error code PX-7002 at line 422",
      "impact": "manualBackup returns plain string instead of TracedError with diagnostics",
      "file": "functions/index.js:422"
    },
    {
      "id": "CLOUD-003",
      "module": "Cloud Functions",
      "severity": "critical",
      "issue": "Golden Rule #7 Violation - Hardcoded error code PX-7008 at line 620",
      "impact": "Error code does NOT exist in error-registry.ts, only in legacy error-codes.ts",
      "file": "functions/index.js:620"
    },
    {
      "id": "CLOUD-004",
      "module": "Cloud Functions",
      "severity": "critical",
      "issue": "Golden Rule #7 Violation - Hardcoded error code PX-7004 at line 962",
      "impact": "manualSmokeTest bypasses ERRORS.BACKUP_SMOKE_TEST_FAILED definition",
      "file": "functions/index.js:962"
    },
    {
      "id": "FIRESTORE-001",
      "module": "Infrastructure (Firestore Rules)",
      "severity": "critical",
      "cvss": "9.1",
      "issue": "Predictions can be modified after race start",
      "impact": "Attacker can bypass API and submit predictions after knowing race results via direct Firestore SDK calls",
      "file": "firestore.rules:49-54"
    },
    {
      "id": "FIRESTORE-002",
      "module": "Infrastructure (Firestore Rules)",
      "severity": "critical",
      "cvss": "8.2",
      "issue": "Missing collection protection for secondary_email_verification_tokens",
      "impact": "No explicit rules. Defaults to deny-all (secure) but represents maintenance risk",
      "file": "firestore.rules (missing rule)"
    },
    {
      "id": "FIRESTORE-003",
      "module": "Infrastructure (Firestore Rules)",
      "severity": "critical",
      "cvss": "7.5",
      "issue": "League invite codes are publicly readable",
      "impact": "Any authenticated user can list all leagues and read invite codes for private leagues",
      "file": "firestore.rules:165-173"
    },
    {
      "id": "FRONTEND-001",
      "module": "Frontend Components",
      "severity": "critical",
      "issue": "XSS vulnerability via dangerouslySetInnerHTML",
      "impact": "Email HTML content rendered without sanitization in admin component. XSS if malicious HTML stored",
      "file": "app/(app)/admin/_components/EmailLogManager.tsx:585"
    },
    {
      "id": "LIB-001",
      "module": "Supporting Libraries",
      "severity": "critical",
      "issue": "Weak randomness in invite code generation",
      "impact": "Modulo bias reduces entropy. Private league security compromised via predictable codes",
      "file": "app/src/lib/leagues.ts:32-40"
    },
    {
      "id": "LIB-002",
      "module": "Supporting Libraries",
      "severity": "critical",
      "issue": "Weak randomness in correlation ID generation",
      "impact": "Math.random() not cryptographically secure. Correlation IDs predictable, audit trail integrity weakened",
      "file": "app/src/lib/firebase-admin.ts:114-118"
    },
    {
      "id": "LIB-003",
      "module": "Supporting Libraries",
      "severity": "critical",
      "issue": "Golden Rule #7 violation - Non-registry error in audit.ts",
      "impact": "Permission errors logged without TracedError or correlation IDs. Inconsistent error handling",
      "file": "app/src/lib/audit.ts:135-143"
    },
    {
      "id": "CONFIG-001",
      "module": "Configuration Files",
      "severity": "critical",
      "issue": "Production secrets exposed in .env.local",
      "impact": "Firebase API key, Graph Client Secret, WhatsApp App Secret visible in plaintext file",
      "file": "app/.env.local:1-23"
    },
    {
      "id": "DEPLOY-001",
      "module": "Deployment Configuration",
      "severity": "critical",
      "issue": "Service account private key exposed in repository (duplicate of BACKUP-001)",
      "impact": "Full administrative access to Firebase project if committed or exposed",
      "file": "service-account.json, whatsapp-worker/service-account.json"
    },
    {
      "id": "DEPLOY-002",
      "module": "Deployment Configuration",
      "severity": "critical",
      "issue": "No secrets management for Azure Container Apps",
      "impact": "Connection strings passed as plaintext environment variables, visible in Azure Portal",
      "file": "whatsapp-worker/deploy-container-app.ps1:44-54,126-128"
    },
    {
      "id": "DEPLOY-003",
      "module": "Deployment Configuration",
      "severity": "critical",
      "issue": "API keys stored in plaintext file",
      "impact": ".api-key.txt NOT in .gitignore. Could be accidentally committed",
      "file": "whatsapp-worker/.api-key.txt"
    },
    {
      "id": "DEPLOY-004",
      "module": "Deployment Configuration",
      "severity": "critical",
      "issue": "No deployment pipeline / CI/CD",
      "impact": "Manual deployments error-prone. No automated tests before production. No audit trail",
      "file": "(missing .github/workflows/)"
    },
    {
      "id": "DEPLOY-005",
      "module": "Deployment Configuration",
      "severity": "critical",
      "issue": "No health check monitoring or alerting",
      "impact": "Services can fail without anyone noticing. Extended downtime. Data loss risk",
      "file": "(monitoring not configured)"
    },
    {
      "id": "ADMINCOMP-001",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "XSS vulnerability via dangerouslySetInnerHTML in public chat panel",
      "impact": "User-generated chat messages rendered without sanitization. Persistent XSS attack vector",
      "file": "app/(app)/admin/_components/PubChatPanel.tsx:333-336"
    },
    {
      "id": "ADMINCOMP-002",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Client-side isAdmin toggle depends on broken API",
      "impact": "TeamManager component allows toggling admin status via client, but admin/update-user API is broken",
      "file": "app/(app)/admin/_components/TeamManager.tsx:112"
    },
    {
      "id": "ADMINCOMP-003",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Client-side admin check can be bypassed",
      "impact": "Admin panel gate at admin/page.tsx:86-104 only checks client-side state, can be circumvented",
      "file": "app/(app)/admin/page.tsx:86-104"
    },
    {
      "id": "ADMINCOMP-004",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Plaintext PIN display in email log manager",
      "impact": "User PINs displayed without masking or access control in admin interface",
      "file": "app/(app)/admin/_components/EmailLogManager.tsx:565"
    },
    {
      "id": "ADMINCOMP-005",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "No server-side auth for site functions, direct Firestore writes",
      "impact": "SiteFunctionsManager performs direct Firestore writes without backend validation",
      "file": "app/(app)/admin/_components/SiteFunctionsManager.tsx:69-70"
    },
    {
      "id": "ADMINCOMP-006",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Direct writes and mass email spam vector in HotNewsManager",
      "impact": "No rate limiting on hot news email broadcasts, direct Firestore writes",
      "file": "app/(app)/admin/_components/HotNewsManager.tsx:94-98,121-129"
    },
    {
      "id": "ADMINCOMP-007",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Race result tampering via direct Firestore writes",
      "impact": "ResultsManager allows direct modification of race results without server validation",
      "file": "app/(app)/admin/_components/ResultsManager.tsx:258-274"
    },
    {
      "id": "ADMINCOMP-008",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Score deletion without validation in ResultsManager",
      "impact": "Admin can delete all user scores via client-side operation, depends on API validation",
      "file": "app/(app)/admin/_components/ResultsManager.tsx:339-349"
    },
    {
      "id": "ADMINCOMP-009",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "Single User Mode DoS attack vector",
      "impact": "OnlineUsersManager allows forcing entire site into single-user mode via client",
      "file": "app/(app)/admin/_components/OnlineUsersManager.tsx:147-195"
    },
    {
      "id": "ADMINCOMP-010",
      "module": "Admin Components Security",
      "severity": "critical",
      "issue": "WhatsApp QR code exposure without authentication",
      "impact": "WhatsAppManager displays QR codes client-side only, no server-side auth check",
      "file": "app/(app)/admin/_components/WhatsAppManager.tsx:214,283-290"
    },
    {
      "id": "GEMINI-001",
      "module": "Gemini Red Team Additional Findings",
      "severity": "critical",
      "issue": "Inconsistent Firestore Security Rules - Two rule files exist",
      "impact": "app/src/firestore.rules vs app/src/firebase/firestore/rules - only weaker one deployed",
      "file": "app/src/firestore.rules, app/src/firebase/firestore/rules"
    },
    {
      "id": "GEMINI-002",
      "module": "Gemini Red Team Additional Findings",
      "severity": "critical",
      "issue": "Insecure League Management Authorization",
      "impact": "Firestore rules lack owner validation for league updates/deletes",
      "file": "firestore.rules:165-173"
    },
    {
      "id": "GEMINI-003",
      "module": "Gemini Red Team Additional Findings",
      "severity": "critical",
      "issue": "HTML Injection in prix_six_engine.py",
      "impact": "LLM-generated newsletter HTML not sanitized before sending to users",
      "file": "prix_six_engine.py"
    },
    {
      "id": "FIRESTORE-004",
      "module": "Firebase Firestore",
      "severity": "critical",
      "issue": "Privilege Escalation via Unprotected 'isAdmin' Flag",
      "impact": "Deployed Firestore rules do not prevent a normal user from setting isAdmin: true on their own user document, allowing any authenticated user to grant themselves administrative privileges",
      "file": "app/src/firestore.rules",
      "citation": "Gemini Red Team (RedTeam.json d9c8b7a6-2d1e-4b7c-8a9a-1b3c2d5e4f6a)"
    },
    {
      "id": "EMAIL-006",
      "module": "Email / Logging",
      "severity": "critical",
      "issue": "Plaintext User PINs are Stored in Firestore Logs",
      "impact": "Application logs users' plaintext 6-digit PINs to the 'email_logs' Firestore collection upon registration. An attacker with read access to this collection can harvest credentials for all new users and take over those accounts",
      "file": "app/src/lib/email.ts",
      "citation": "Gemini Red Team (RedTeam.json d1e2f3a4-b5c6-d7e8-f9a0-b1c2d3e4f5a6)"
    },
    {
      "id": "FIRESTORE-005",
      "module": "Firebase Firestore",
      "severity": "critical",
      "issue": "Insecure Client-Side Account Deletion (Due to rules deficiency)",
      "impact": "Deployed Firestore rules allow a user with the isAdmin: true flag to delete user documents. Since the isAdmin flag itself is unprotected (Finding: FIRESTORE-004), this effectively means any user can delete any other user's account if they escalate their privileges",
      "file": "app/src/firestore.rules",
      "citation": "Gemini Red Team (RedTeam.json f9a8b7c6-d5e4-4f3b-2a1c-8d7e6f5a4b3c)"
    },
    {
      "id": "SCRIPTS-001",
      "module": "Operational Scripts",
      "severity": "high",
      "issue": "Unprotected Destructive/Administrative Operational Scripts",
      "impact": "Repository contains multiple scripts (reset-db.ts, delete-all-scores.ts, fix-protected-scores.ts, fix-secondary.ts, migrate-create-global-league.ts, purge-temp-data.ts, qa-verify.ts, quick-check.ts, recalculate-all-scores.ts, recalculate-aus-scores.ts, recalculate-scores.ts, seed-40-teams.ts, seed-big-shakedown.ts, update-feature-feedback.ts, verify-admin.ts, verify-big-shakedown.ts) that perform destructive or administrative actions on the database without any safety checks (e.g., environment validation, confirmation prompts). Accidental execution against production would result in catastrophic data loss or corruption",
      "file": "scripts/reset-db.ts, app/scripts/*.ts (16 scripts)",
      "citation": "Gemini Red Team (RedTeam.json b3a2c1d0-9e8f-4a7b-8c6d-5e4f3b2a1c0d)"
    },
    {
      "id": "STANDS-001",
      "module": "Standings",
      "severity": "medium",
      "issue": "Denial of Wallet via Unbounded Firestore Read",
      "impact": "Standings page fetches the entire 'scores' collection from Firestore to perform client-side calculations. A malicious actor could repeatedly load this page to trigger a massive number of document reads, leading to exorbitant costs and effectively creating a Denial of Wallet (DoW) attack. Aggregations should be performed on the backend",
      "file": "app/src/app/(app)/standings/page.tsx",
      "citation": "Gemini Red Team (RedTeam.json a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6)"
    },
    {
      "id": "AUTH-004",
      "module": "API / Authentication",
      "severity": "medium",
      "issue": "Use of Low-Entropy PIN as Primary Authentication Factor",
      "impact": "Application's primary credential is a 6-digit PIN with very low entropy (1 million combinations). While strong lockout controls are in place, this is an architecturally weak choice. If any flaw were found in the lockout logic, accounts would be trivial to compromise. The app/scripts/verify-admin.ts script directly sets the admin user's password to ADMIN_PIN, exacerbating this risk for a privileged account",
      "file": "app/src/app/api/auth/login/route.ts, app/scripts/verify-admin.ts",
      "citation": "Gemini Red Team (RedTeam.json b4c5d6e7-f8a9-b0c1-d2e3-f4a5b6c7d8e9)"
    },
    {
      "id": "ATTACK-001",
      "module": "Security / Attack Detection",
      "severity": "medium",
      "issue": "Attack Detection System Is Designed to 'Fail Open'",
      "impact": "Entire intrusion detection system is designed to catch all errors and fail silently, allowing the login process to continue. This means a failure in the IDS (e.g., a bad database query, a missing index) will render it blind to ongoing attacks, prioritizing availability over security monitoring. A robust IDS should alert administrators when it is not functioning correctly",
      "file": "app/src/lib/attack-detection.ts",
      "citation": "Gemini Red Team (RedTeam.json e7f8a9b0-c1d2-e3f4-a5b6-c7d8e9f0a1b2)"
    },
    {
      "id": "FIRESTORE-006",
      "module": "Firebase Firestore",
      "severity": "medium",
      "issue": "Unprotected User Enumeration via `users` collection `list`",
      "impact": "Firestore rule 'match /users/{userId} { allow get, list: if isSignedIn(); }' allows any signed-in user to list all user documents. This enables user enumeration, potentially exposing user IDs, team names, and email addresses, which could aid attackers in targeting specific users",
      "file": "app/src/firestore.rules",
      "citation": "Gemini Red Team (RedTeam.json a3b4c5d6-e7f8-a9b0-c1d2-e3f4a5b6c7d8)"
    },
    {
      "id": "SCRIPTS-002",
      "module": "Operational Scripts",
      "severity": "low",
      "issue": "Hardcoded 'Protected User' List in Administrative Scripts",
      "impact": "Scripts contain hardcoded lists of specific email addresses (PROTECTED_EMAILS) to identify 'protected users' for administrative data corrections. This brittle practice is prone to errors, makes maintenance difficult, and indicates poor operational security hygiene. The app/scripts/verify-admin.ts script uses a hardcoded ADMIN_EMAIL that serves a similar purpose for specific identity management. The app/scripts/verify-big-shakedown.ts script also uses hardcoded user IDs for verification checks",
      "file": "app/scripts/fix-protected-scores.ts, app/scripts/seed-big-shakedown.ts, app/scripts/verify-admin.ts, app/scripts/verify-big-shakedown.ts",
      "citation": "Gemini Red Team (RedTeam.json e6f7a8b9-c0d1-e2f3-a4b5c6d7e8f9)"
    },
    {
      "id": "FRONTEND-PERF-001",
      "module": "Frontend Performance",
      "severity": "medium",
      "issue": "Next.js Chunk Loading Timeouts",
      "impact": "Users experiencing slow connections get ChunkLoadError preventing page load. Multiple reports from production (chunks 5239, 5463, 2992, 9268) across signup, forgot-pin, and home routes. Network timeout issues causing poor UX for users on slow connections or unstable networks.",
      "file": "Next.js webpack configuration",
      "recommendation": "Investigate CDN performance, implement chunk loading retry logic with exponential backoff, or increase webpack chunk timeout threshold. Consider code-splitting optimization to reduce chunk sizes.",
      "errorLogs": ["MeLO5qEnbl9pD3InZMLE", "tUFRzXlSKPe2QEMIKJUT", "ymWCi7LRuhQkxDXhePAx", "JxAVotVuZXVD6ovDU5E6", "5VjFkZP4kcNLIZ4ONckX", "pHxo5mK0N2CNcOw5zOGo"]
    },
    {
      "id": "FRONTEND-COMPAT-001",
      "module": "Frontend Compatibility",
      "severity": "low",
      "issue": "Old Browser Compatibility - instanceof Errors",
      "impact": "Users with very old browsers (Chrome 45 from 2015, Chrome 116) experiencing crashes with 'Right-hand side of instanceof is not an object' error. Affects small percentage of users but results in complete application failure for them.",
      "file": "Next.js compiled bundles",
      "recommendation": "Add browser version detection on entry and show upgrade message for unsupported browsers, or add polyfills for older browsers. Consider setting minimum browser version requirement and displaying graceful degradation message.",
      "errorLogs": ["pTdUSzR1TFUHIVjD0xuq", "NyWABVtLY5C8YAhxbrfI", "jNT027RsrOg2q0H2B76F"]
    },
    {
      "id": "FIRESTORE-007",
      "module": "Firebase Firestore",
      "severity": "critical",
      "issue": "Audit Log Write Permission Denied for Admin User",
      "impact": "Admin user aaron@garcia.ltd cannot write navigation logs to audit_logs collection when authenticated via Apple provider. Firestore Security Rules are rejecting create operations for audit_logs collection despite user being authenticated. This breaks the audit trail functionality for admin users.",
      "file": "firestore.rules",
      "recommendation": "Review audit_logs Firestore Security Rules. Current rules may not properly allow write access for authenticated users. Need to ensure audit logging works for all authentication providers (Apple, Google, password).",
      "errorLog": "VA3fnT4Zs7YTpMHDD97U",
      "context": {
        "userId": "caPArwBSQHaZU48HHF2YjFDoxo93",
        "email": "aaron@garcia.ltd",
        "provider": "apple.com",
        "action": "navigate",
        "path": "/about",
        "timestamp": "2026-02-12T22:30:32.444Z"
      }
    }
  ]
}