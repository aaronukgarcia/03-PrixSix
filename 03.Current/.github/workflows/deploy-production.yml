# GUID: WORKFLOW_DEPLOY_PROD-000-v01
# @PHASE_3B: CI/CD pipeline for automated testing, security scanning, and deployment (DEPLOY-004).
# [Intent] Automates the build-test-deploy cycle with security gates and manual approval.
#          Validates Golden Rule #2 (version consistency) before deployment.
# [Inbound Trigger] Push to main branch or manual workflow dispatch.
# [Downstream Impact] Failed tests or security scans block deployment. Manual approval required
#                     for production deployment to prevent accidental releases.

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

# GUID: WORKFLOW_DEPLOY_PROD-001-v01
# [Intent] Environment variables shared across all jobs in the workflow.
# [Inbound Trigger] Set once at workflow start, available to all jobs.
# [Downstream Impact] NODE_ENV affects build optimizations. Changes here affect all jobs.
env:
  NODE_VERSION: '20.x'
  NODE_ENV: 'production'

jobs:
  # GUID: WORKFLOW_DEPLOY_PROD-002-v01
  # [Intent] Validate version consistency between package.json and version.ts (Golden Rule #2).
  #          This prevents deployments with version mismatches that confuse users.
  # [Inbound Trigger] Runs on every push to main or manual dispatch.
  # [Downstream Impact] Deployment blocked if versions don't match. Forces developer to sync.
  validate-version:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency (Golden Rule #2)
        run: |
          cd app
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          VERSION_TS=$(grep -oP 'APP_VERSION = "\K[^"]+' src/lib/version.ts)

          echo "package.json version: $PACKAGE_VERSION"
          echo "version.ts version: $VERSION_TS"

          if [ "$PACKAGE_VERSION" != "$VERSION_TS" ]; then
            echo "❌ ERROR: Version mismatch detected!"
            echo "Golden Rule #2 violation: package.json and version.ts must match"
            echo "Please update version.ts to match package.json: $PACKAGE_VERSION"
            exit 1
          fi

          echo "✅ Version consistency validated: $PACKAGE_VERSION"

  # GUID: WORKFLOW_DEPLOY_PROD-003-v01
  # [Intent] Run unit and integration tests to verify code correctness before deployment.
  # [Inbound Trigger] Runs in parallel with security-scan after version validation.
  # [Downstream Impact] Failed tests block deployment. Test coverage reports uploaded as artifacts.
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate-version
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --coverage --passWithNoTests

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: app/coverage/
          retention-days: 30

  # GUID: WORKFLOW_DEPLOY_PROD-004-v01
  # [Intent] Run Semgrep security scans to detect vulnerabilities before deployment.
  #          Scans for OWASP Top 10, credential leaks, XSS, injection flaws.
  # [Inbound Trigger] Runs in parallel with test after version validation.
  # [Downstream Impact] Security findings block deployment if severity is high/critical.
  security-scan:
    name: Security Scan (Semgrep)
    runs-on: ubuntu-latest
    needs: validate-version
    permissions:
      security-events: write # Required for SARIF upload
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep security scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/typescript
            p/react
          generateSarif: true

      - name: Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # GUID: WORKFLOW_DEPLOY_PROD-005-v01
  # [Intent] Build the Next.js application to verify build succeeds before deployment.
  #          Build artifacts are not uploaded (Firebase builds on deploy).
  # [Inbound Trigger] Runs after tests and security scans pass.
  # [Downstream Impact] Build failures block deployment. Validates TypeScript types and Next.js config.
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true # Skip .env validation in CI

  # GUID: WORKFLOW_DEPLOY_PROD-006-v01
  # [Intent] Deploy to Firebase Hosting and Cloud Functions with manual approval gate.
  #          Uses Firebase service account credentials stored in GitHub Secrets.
  # [Inbound Trigger] Manual approval required after build succeeds. Only on main branch.
  # [Downstream Impact] Updates production site. Downtime possible if Cloud Functions redeploy.
  #                     Rollback available via Firebase Hosting version history.
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://prix6.win
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: prix-six
          entryPoint: ./app

  # GUID: WORKFLOW_DEPLOY_PROD-007-v01
  # [Intent] Post-deployment smoke tests to verify critical functionality after deploy.
  #          Checks health endpoint, login page accessibility, and API responsiveness.
  # [Inbound Trigger] Runs after successful deployment to production.
  # [Downstream Impact] Failed smoke tests trigger alerts but don't roll back automatically.
  #                     Manual intervention required to investigate or rollback.
  smoke-test:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Check health endpoint
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://prix6.win/api/health)
          if [ $RESPONSE -ne 200 ]; then
            echo "❌ Health check failed: HTTP $RESPONSE"
            exit 1
          fi
          echo "✅ Health check passed: HTTP $RESPONSE"

      - name: Check login page accessibility
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://prix6.win/login)
          if [ $RESPONSE -ne 200 ]; then
            echo "❌ Login page check failed: HTTP $RESPONSE"
            exit 1
          fi
          echo "✅ Login page accessible: HTTP $RESPONSE"

      - name: Verify version deployed
        run: |
          # Extract version from health endpoint (if it returns it)
          # For now, just verify API is responding
          RESPONSE=$(curl -s https://prix6.win/api/health | jq -r '.version // empty')
          if [ -n "$RESPONSE" ]; then
            echo "✅ Deployed version: $RESPONSE"
          else
            echo "⚠️  Could not verify deployed version"
          fi
